FROM tensorflow/tensorflow:1.13.1-gpu-py3 as base

USER root
# set up the basic image

ENV USER=cleverspeech
ENV USER_ID=9999
ENV GROUP_ID=9999

RUN groupadd -g ${GROUP_ID} ${USER}
RUN useradd -m ${USER} -g ${GROUP_ID} -u ${USER_ID}

RUN apt update
RUN apt install -y \
	git \
	curl \
	wget \
	software-properties-common \
	libsndfile1 \
	sox \
	libsox-dev \
	swig \
	nano \
	sudo \
	python3 \
	llvm-8*

# https://askubuntu.com/questions/1286131/how-do-i-install-llvm-10-on-ubuntu-18-04/1286132
# but with llvm version 8
RUN ln -s /usr/bin/llvm-config-8 /usr/bin/llvm-config
USER cleverspeech
ENV CLEVERSPEECH_URL=https://github.com/dijksterhuis/cleverSpeech
RUN git clone --recurse-submodules ${CLEVERSPEECH_URL} /home/cleverspeech/cleverSpeech


#############################

FROM base as dsdownloads
USER cleverspeech
WORKDIR /home/cleverspeech/cleverSpeech
RUN ./bin/deepspeech/get-model-files.sh

#############################

FROM base as csdownloads
USER cleverspeech
WORKDIR /home/cleverspeech/cleverSpeech
RUN ./bin/attacks/create-samples-dir.sh

#############################

FROM base as installs

USER cleverspeech
WORKDIR /home/cleverspeech/cleverSpeech
RUN pip3 install --upgrade --user -r ./models/*/src/requirements.txt
RUN pip3 install --upgrade --user -r ./reqs.txt

COPY --from=dsdownloads /home/cleverspeech/cleverSpeech/models/DeepSpeech/data/ ./models/DeepSpeech/data/
COPY --from=csdownloads /home/cleverspeech/cleverSpeech/samples/ ./samples/

ENV PYTHONPATH="${PYTHONPATH}:$(pwd):$(pwd)/models/DeepSpeech/src"

# Build DeepSpeech decoder
USER root
WORKDIR /home/cleverspeech/cleverSpeech/models/DeepSpeech/src/native_client/ctcdecode
RUN make bindings NUM_PROCESSES=2

USER cleverspeech
RUN pip3 install --user --force-reinstall ./dist/*.whl

# Entrypoints and clean up
RUN rm -rf /tmp/*

#############################

FROM decoder

# entrypoint must be run as root so we can switch users
USER root
COPY ./docker/entrypoint.sh /entrypoint.sh
WORKDIR /home/cleverspeech/cleverSpeech
ENTRYPOINT ["/bin/bash", "/entrypoint.sh"]

